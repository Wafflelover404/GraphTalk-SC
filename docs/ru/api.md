# api.py - Основное приложение FastAPI

## Обзор
Основное приложение FastAPI, которое обеспечивает безопасный REST API для взаимодействия с базами знаний OSTIS. Это точка входа в систему GraphTalk.

## Основные функции
- **Аутентификация на основе токенов**: Безопасный доступ к API с использованием токенов
- **Запросы к базе знаний**: Обработка запросов на естественном языке к базам знаний OSTIS
- **Поддержка загрузки файлов**: Загрузка и обработка ZIP-файлов базы знаний
- **Интеграция с языковыми моделями**: Опциональные ответы на основе моделей языка
- **Интерактивная документация**: Swagger UI с аутентификацией

## Архитектура
```
Приложение FastAPI
├── Слой аутентификации (токен)
├── Обработка запросов (/query)
├── Загрузка файлов (/upload/kb_zip)
├── Управление токенами (/create_token)
└── Документация (/docs)
```

## Конечные точки

### Аутентификация
- **POST /create_token**: Генерация нового токена доступа (только один раз)
  - Возвращает безопасный токен для доступа к API
  - Разрешает создание только одного токена для установки

### Основные операции
- **POST /query**: Обработка запросов к базе знаний
  - Параметры:
    - `text`: Строка запроса
    - `humanize`: Опционально, для получения более человечных ответов
  - Возвращает структурированные результаты поиска или человечные ответы

- **POST /upload/kb_zip**: Загрузка файлов базы знаний
  - Принимает ZIP-файлы, содержащие .scs файлы (Semantic Computer Source)
  - Извлекает и загружает в систему OSTIS
  - Возвращает статус обработки

### Документация
- **GET /docs**: Интерактивная документация по API (требуется аутентификация)
- **GET /**: Главная страница с обзором конечных точек

## Функции безопасности
- **Система единого токена**: Можно создать только один токен доступа
- **хеширование bcrypt**: Безопасное хранение токенов с использованием bcrypt с 12 раундами
- **Проверка токенов**: Все защищенные конечные точки требуют действительный токен
- **Проверка файлов**: Ограничение чтения только на ZIP-файлы

## Конфигурация
- **Директория загрузки**: `uploaded_kbs/` - Хранит загруженные файлы
- **Основная директория базы знаний**: `unpacked_kbs/` - Временное место для извлечения
- **Путь к секретам**: `~/secrets.toml` - Место для хранения токенов
- **Порт по умолчанию**: 9001 (при запуске напрямую)

## Зависимости
- **FastAPI**: Веб-фреймворк
- **uvicorn**: Сервер ASGI
- **bcrypt**: Хеширование паролей/токенов
- **toml**: Обработка конфигурационных файлов
- **sc_search**: Функциональность поиска по базе знаний

## Пример использования
```python
# Запуск сервера
uvicorn api:app --host 0.0.0.0 --port 9001

# Создание токена (только первый запуск)
curl -X POST http://localhost:9001/create_token

# Запрос с использованием токена
curl -X POST http://localhost:9001/query \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"text": "What is OSTIS?"}'
```

## Обработка ошибок
- Всеобъемлющая обработка исключений для всех конечных точек
- Структурированные ответы об ошибках со статусом и сообщением
- Журналирование критических ошибок для отладки
- Мягкая обработка сбоев подключения к OSTIS

## Точки интеграции
- **sc_search.py**: Основная функциональность поиска
- **llm.py**: Интеграция языковых моделей для более человечных ответов
- **memloader.py**: Обработка файлов базы знаний
- **Сервер OSTIS**: Подключение через WebSocket по адресу `ws://localhost:8090`
