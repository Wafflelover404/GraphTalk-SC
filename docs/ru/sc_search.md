# sc_search.py - Основной поиск по базе знаний

## Обзор
Обеспечивает быструю, нерекурсивную функциональность поиска по базам знаний OSTIS. Этот модуль реализует эффективный поиск по подстроке с автоматическим декодированием элементов.

## Основные функции
- **Быстрый поиск**: Быстрый поиск по подстроке через ссылки базы знаний
- **Автоматическое декодирование**: Преобразует адреса SC-машины в удобочитаемый контент
- **Управление подключением**: Обрабатывает подключения WebSocket к серверу OSTIS
- **Обработка ошибок**: Надежная обработка ошибок с информативными сообщениями

## Основная функция

### `kb_search(search_string)`
Выполняет быстрый поиск по базе знаний с использованием предоставленной строки запроса.

#### Параметры
- `search_string` (str): Строка запроса для поиска в базе знаний

#### Возвращает
- `list`: Список строк, содержащих результаты поиска, где каждый результат может быть:
  - `"Keynode: {identifier}"` - Системно-определенные узлы
  - `"Link Content: {content}"` - Контент из ссылок базы знаний
  - `"Unknown Element: {address}"` - Неидентифицированные элементы
  - `"Error during search: {error}"` - Сообщения об ошибках

#### Алгоритм
1. **Настройка подключения**: Устанавливает подключение WebSocket к серверу OSTIS (`ws://localhost:8090/ws_json`)
2. **Создание контекста**: Создает ссылку контекста поиска с поисковой строкой
3. **Разделение термов**: Разделяет поисковую строку на отдельные термы
4. **Поиск по ссылкам**: Использует `search_links_by_contents_substrings()` для поиска подходящих ссылок
5. **Обработка результатов**: Декодирует каждый найденный адрес с использованием:
   - `get_element_system_identifier()` для ключевых узлов
   - `get_link_content_data()` для содержания ссылок
6. **Очистка**: Автоматически отключается от сервера

## Стратегия поиска
```
Входной запрос → Разделить термы → Поиск по ссылкам → Декодировать результаты → Вернуть список
    ↓               ↓              ↓              ↓              ↓
  "OSTIS AI" → ["OSTIS", "AI"] → [addr1, addr2] → ["Keynode: OSTIS", "Link Content: AI"] → Результаты
```

## Детали подключения
- **URL**: `ws://localhost:8090/ws_json`
- **Протокол**: Протокол WebSocket JSON
- **Авто-отключение**: Подключение автоматически закрывается после поиска

## Зависимости
- **sc_client**: OSTIS клиентская библиотека на Python
  - `connect`, `disconnect`, `is_connected`
  - `search_links_by_contents_substrings`
  - `generate_elements`
- **sc_kpm.utils**: Утилиты обработки знаний
  - `get_element_system_identifier`
  - `get_link_content_data`

## Примеры использования

### Базовый поиск
```python
from sc_search import kb_search

# Поиск содержимого, связанного с OSTIS
results = kb_search("OSTIS technology")
for result in results:
    print(result)
# Вывод:
# Keynode: ostis_technology
# Link Content: OSTIS is a technology for building knowledge bases
```

### Несколько термов
```python
# Поиск по нескольким ключевым словам
results = kb_search("semantic networks AI")
# Ищет содержимое, содержащее "semantic", "networks" или "AI"
```

### Обработка ошибок
```python
results = kb_search("test query")
if results and "Error during search:" in results[0]:
    print("Ошибка поиска:", results[0])
else:
    print(f"Найдено {len(results)} результатов")
```

## Характеристики производительности
- **Скорость**: Быстрое выполнение благодаря нерекурсивной природе
- **Память**: Минимальное использование памяти, без кеширования
- **Масштабируемость**: Производительность зависит от размера базы знаний
- **Подключение**: Новое подключение для каждого поиска (без состояния)

## Сценарии ошибок
1. **Сбой подключения**: Возвращает `["Not connected to SC-machine"]`
2. **Сервер недоступен**: Возвращает `["Error during search: connection error"]`
3. **Недопустимый запрос**: Обрабатывается осторожно, может вернуть пустые результаты
4. **Тайм-аут сервера**: Автоматический тайм-аут и отчет об ошибке

## Интеграция с API
Используется в `api.py` в конечной точке `/query`:
```python
# В api.py
from sc_search import kb_search

@app.post("/query")
async def process_query(request: QueryRequest, humanize: bool = False):
    kb_results = kb_search(request.text)
    # ... обработка результатов
```

## Сравнение с sc_search-total.py
| Функция | sc_search.py | sc_search-total.py |
|---------|--------------|----------------------|
| Скорость | Быстро | Медленнее |
| Глубина | Одноуровневый | Рекурсивный (настраиваемый) |
| Память | Низкое использование | Более высокое использование |
| Сложность | Простой | Сложные отношения |
| Использование | Быстрый поиск | Глубокий анализ |

## Лучшие практики
1. **Проектирование запросов**: Используйте конкретные термы для улучшения результатов
2. **Проверка ошибок**: Всегда проверяйте наличие сообщений об ошибках в результатах
3. **Подключение**: Убедитесь, что сервер OSTIS запущен перед поиском
4. **Выбор термов**: Избегайте чрезмерно общих терминов, которые могут переполнить результаты

